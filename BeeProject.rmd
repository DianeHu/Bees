---
title: "BeeProject"
author: "Diane Hu, Ashka Stephen, Jarod Cahoon"
date: "November 30, 2018"
output: html_document
---

```{r setup, message=F,include=F}
knitr::opts_chunk$set(echo = TRUE)
options(knitr.kable.NA = '')
```

```{r,include=FALSE}
library("tibble")
library("dplyr")
library("ggplot2")
library("broom")
library("knitr")
library("cowplot")
```

```{r}
honey <- read.csv("vHoneyNeonic_v02.csv")
honey <- na.omit(honey)

c <- 10 ** (-8)

honey <- honey %>% mutate(clothInd = as.numeric(nCLOTHIANIDIN > 0), imidInd = as.numeric(nIMIDACLOPRID > 0), thiamInd = as.numeric(nACETAMIPRID > 0), acetInd = as.numeric(nACETAMIPRID > 0), thiacInd = as.numeric(nTHIACLOPRID > 0))

honey <- honey %>% mutate(nCLOTHIANIDIN = nCLOTHIANIDIN + c, nIMIDACLOPRID = nIMIDACLOPRID + c, nTHIAMETHOXAM = nTHIAMETHOXAM + c, nACETAMIPRID = nACETAMIPRID + c, nTHIACLOPRID = nTHIACLOPRID + c)

glimpse(honey)
```

```{r}
set.seed(7)

numObs <- summarize(honey, n = n())

honeySample <- sample_n(honey, as.integer(0.25*numObs))

honeySample <- honeySample %>% mutate(logCloth = log(nCLOTHIANIDIN), logIMID = log(nIMIDACLOPRID), logTHIAM = log(nTHIAMETHOXAM), logACET = log(nACETAMIPRID), logTHIAC = log(nTHIACLOPRID), logNC = log(numcol))

#honeySample$logCloth[which(!is.finite(honeySample$logCloth))] = NA
#honeySample$logIMID[which(!is.finite(honeySample$logIMID))] = NA
#honeySample$logTHIAM[which(!is.finite(honeySample$logTHIAM))] = NA
#honeySample$logACET[which(!is.finite(honeySample$logACET))] = NA
#honeySample$logTHIAC[which(!is.finite(honeySample$logTHIAC))] = NA

#honeySample <- na.omit(honeySample)

glimpse(honeySample)
```

```{r}
# Numcol against everything for exp data analysis

#ncYear <- ggplot(honeySample, aes(x = year, y = numcol)) + geom_point() + geom_line() + ggtitle("Number of Colonies vs Year")
#ncCloth <- ggplot(honeySample, aes(x = nCLOTHIANIDIN, y = numcol)) + geom_point() + ggtitle("Number of Colonies vs nCLOTHIANIDIN")
#ncIMID <- ggplot(honeySample, aes(x = nIMIDACLOPRID, y = numcol)) + geom_point() + ggtitle("Number of Colonies vs nIMIDACLOPRID")
#ncTHIAM <- ggplot(honeySample, aes(x = nTHIAMETHOXAM, y = numcol)) + geom_point() + ggtitle("Number of Colonies vs nTHIAMETHOXAM")
#ncACET <- ggplot(honeySample, aes(x = nACETAMIPRID, y = numcol)) + geom_point() + ggtitle("Number of Colonies vs nACETAMIPRID")
#ncTHIAC <- ggplot(honeySample, aes(x = nTHIACLOPRID, y = numcol)) + geom_point() + ggtitle("Number of Colonies vs nTHIACLOPRID")
#ncRegion <- ggplot(honeySample, aes(x = Region, y = numcol)) + geom_boxplot() + ggtitle("Number of colonies vs Region")

cl <- honeySample %>% filter(clothInd > 0)
im <- honeySample %>% filter(imidInd > 0)
thm <- honeySample %>% filter(thiamInd > 0)
ac <- honeySample %>% filter(acetInd > 0)
thc <- honeySample %>% filter(thiacInd > 0)

ncYear <- ggplot(honeySample, aes(x = year, y = numcol)) + geom_point() + geom_line() + ggtitle("Number of Colonies vs Year")

ncCloth <- ggplot(cl, aes(x = nCLOTHIANIDIN, y = numcol)) + geom_point() + ggtitle("Number of Colonies vs nCLOTHIANIDIN")

ncIMID <- ggplot(im, aes(x = nIMIDACLOPRID, y = numcol)) + geom_point() + ggtitle("Number of Colonies vs nIMIDACLOPRID")

ncTHIAM <- ggplot(thm, aes(x = nTHIAMETHOXAM, y = numcol)) + geom_point() + ggtitle("Number of Colonies vs nTHIAMETHOXAM")

ncACET <- ggplot(ac, aes(x = nACETAMIPRID, y = numcol)) + geom_point() + ggtitle("Number of Colonies vs nACETAMIPRID")

ncTHIAC <- ggplot(thc, aes(x = nTHIACLOPRID, y = numcol)) + geom_point() + ggtitle("Number of Colonies vs nTHIACLOPRID")

ncRegion <- ggplot(honeySample, aes(x = Region, y = numcol)) + geom_boxplot() + ggtitle("Number of colonies vs Region")

```

```{r}
ncYear
ncCloth
ncIMID
ncTHIAM
ncACET
ncTHIAC
ncRegion
```

```{r}
# Transformations

ncLCloth <- ggplot(cl, aes(x = logCloth, y = logNC)) + geom_point() + ggtitle("Logged Number of Colonies vs Log nCLOTHIANIDIN")

ncLIMID <- ggplot(im, aes(x = logIMID, y = logNC)) + geom_point() + ggtitle("Logged Number of Colonies vs Log nIMIDACLOPRID")

ncLTHIAM <- ggplot(thm, aes(x = logTHIAM, y = logNC)) + geom_point() + ggtitle("Logged Number of Colonies vs Log nTHIAMETHOXAM")

ncLACET <- ggplot(ac, aes(x = logACET, y = logNC)) + geom_point() + ggtitle("Logged Number of Colonies vs Log nACETAMIPRID")

ncLTHIAC <- ggplot(thc, aes(x = logTHIAC, y = logNC)) + geom_point() + ggtitle("Logged Number of Colonies vs Log nTHIACLOPRID")

#ncLCloth <- ggplot(honeySample, aes(x = logCloth, y = numcol)) + geom_point() + ggtitle("Number of Colonies vs Log nCLOTHIANIDIN")
#ncLIMID <- ggplot(honeySample, aes(x = logIMID, y = numcol)) + geom_point() + ggtitle("Number of Colonies vs Log nIMIDACLOPRID")
#ncLTHIAM <- ggplot(honeySample, aes(x = logTHIAM, y = numcol)) + geom_point() + ggtitle("Number of Colonies Log vs nTHIAMETHOXAM")
#ncLACET <- ggplot(honeySample, aes(x = logACET, y = numcol)) + geom_point() + ggtitle("Number of Colonies vs Log nACETAMIPRID")
#ncLTHIAC <- ggplot(honeySample, aes(x = logTHIAC, y = numcol)) + geom_point() + ggtitle("Number of Colonies vs Log nTHIACLOPRID")
```

```{r}
ncLCloth
ncLIMID
ncLTHIAM
ncLACET
ncLTHIAC
```

```{r}
cal <- honey %>% filter(StateName == "California")

glimpse(cal)
```

```{r}

ccl <- cal %>% filter(clothInd > 0)
cim <- cal %>% filter(imidInd > 0)
cthm <- cal %>% filter(thiamInd > 0)
cac <- cal %>% filter(acetInd > 0)
cthc <- cal %>% filter(thiacInd > 0)

cYear <- ggplot(cal, aes(x = year, y = numcol)) + geom_point() + geom_line() + ggtitle("Number of California Colonies vs Year")
cLCloth <- ggplot(ccl, aes(x = nCLOTHIANIDIN, y = numcol)) + geom_point() + ggtitle("Number of California Colonies vs nCLOTHIANIDIN")
cLIMID <- ggplot(cim, aes(x = nIMIDACLOPRID, y = numcol)) + geom_point() + ggtitle("Number of California Colonies vs nIMIDACLOPRID")
cLTHIAM <- ggplot(cthm, aes(x = nTHIAMETHOXAM, y = numcol)) + geom_point() + ggtitle("Number of California Colonies vs nTHIAMETHOXAM")
cLACET <- ggplot(cac, aes(x = nACETAMIPRID, y = numcol)) + geom_point() + ggtitle("Number of California Colonies vs nACETAMIPRID")
cLTHIAC <- ggplot(cthc, aes(x = nTHIACLOPRID, y = numcol)) + geom_point() + ggtitle("Number of California Colonies vs nTHIACLOPRID")
```

```{r}
cYear
cLCloth
cLIMID
cLTHIAM
cLACET
cLTHIAC
```

# Model

```{r}
glimpse(honeySample)
```

```{r}
numcolFull <- lm(logNC ~ Region + logCloth + logIMID + logTHIAM + logACET + logTHIAC + clothInd + imidInd + thiamInd + acetInd + thiacInd + logCloth*clothInd + logIMID*imidInd + logTHIAM*thiamInd + logACET*acetInd + logTHIAC*thiacInd, data=honeySample)
kable(tidy(numcolFull))
```

```{r}
library(olsrr)
ols_step_forward_aic(numcolFull)
```

```{r}
regionOnly <- lm(logNC ~ Region, data=honeySample)
cloth <- lm(logNC ~ Region + logCloth + clothInd + clothInd*logCloth, data=honeySample)
imid <- lm(logNC ~ Region + logIMID + imidInd + imidInd*logIMID, data=honeySample)
acet <- lm(logNC ~ Region + logACET + acetInd + acetInd*logACET, data=honeySample)
thiam <- lm(logNC ~ Region + logTHIAM + thiamInd + thiamInd*logTHIAM, data=honeySample)
thiac <- lm(logNC ~ Region + logTHIAC + thiacInd + thiacInd*logTHIAC, data=honeySample)
anova(regionOnly, cloth)
```

```{r}
anova(regionOnly, imid)
```

```{r}
anova(regionOnly, acet)
```

```{r}
anova(regionOnly, thiam)
```

```{r}
anova(regionOnly, thiac)
```

```{r}
baseModel <- lm(logNC ~ Region + logIMID + logACET + logTHIAM + logTHIAC + imidInd + acetInd + thiamInd + thiacInd + imidInd*logIMID + acetInd*logACET + thiamInd*logTHIAM + thiacInd*logTHIAM, data=honeySample)

interactionsModel <- lm(logNC ~ Region + logIMID + logACET + logTHIAM + logTHIAC + imidInd + acetInd + thiamInd + thiacInd + imidInd*logIMID + acetInd*logACET + thiamInd*logTHIAM + thiacInd*logTHIAM + Region*logIMID + Region*logACET + Region*logTHIAC + Region*logTHIAM, data=honeySample)

kable(anova(baseModel, interactionsModel), format="html") # interactions significant
```

```{r}
glimpse(cal)
```

```{r}
yearOnly <- lm(numcol ~ year, data=cal)
calCloth <- lm(numcol ~ year + nCLOTHIANIDIN + clothInd + clothInd*nCLOTHIANIDIN, data=cal)
calImid <- lm(numcol ~ year + nIMIDACLOPRID + imidInd + imidInd*nIMIDACLOPRID, data=cal)
calThiam <- lm(numcol ~ year + nTHIAMETHOXAM + thiamInd + thiamInd*nTHIAMETHOXAM, data=cal)
calAcet <- lm(numcol ~ year + nACETAMIPRID + acetInd + acetInd*nACETAMIPRID, data=cal)
calThiac <- lm(numcol ~ year + nTHIACLOPRID + thiacInd + thiacInd*nTHIACLOPRID, data=cal)
```

```{r}
anova(yearOnly, calCloth)
```

```{r}
anova(yearOnly, calImid)
```
```{r}
anova(yearOnly, calThiam)
```

```{r}
anova(yearOnly, calAcet)
```

```{r}
anova(yearOnly, calThiac)
```


```{r}
calBase <- lm(numcol ~ year, data=cal)
```

# Assumptions

```{r}

kable(tidy(interactionsModel))
```

# Model 1
```{r}
interactionsModel <- lm(logNC ~ Region + logIMID + logACET + logTHIAM + logTHIAC + Region*logIMID + Region*logACET + Region*logTHIAC + Region*logTHIAM +thiamInd + thiamInd*logTHIAM + thiacInd + thiacInd*logTHIAM, data=honeySample)

honeySample <- honeySample %>% mutate(Residuals = resid(interactionsModel), Predicted = predict(interactionsModel))

ggplot(data=honeySample,aes(x=Region,y=Residuals)) + geom_point() + 
  geom_hline(yintercept=0,color="red") + 
   labs(title="Residuals vs. Region") + 
  theme(plot.title = element_text(hjust=0.5))

ggplot(data=honeySample,aes(x=logIMID*imidInd,y=Residuals)) + geom_point() + 
  geom_hline(yintercept=0,color="red") + 
   labs(title="Residuals vs. logIMID*indicator") + 
  theme(plot.title = element_text(hjust=0.5))

ggplot(data=honeySample,aes(x=Predicted,y=Residuals)) + geom_point() + 
  geom_hline(yintercept=0,color="red") + 
   labs(title="Residuals vs. Predicted") + 
  theme(plot.title = element_text(hjust=0.5))

ggplot(data=honeySample,aes(x=logACET*acetInd,y=Residuals)) + geom_point() + 
  geom_hline(yintercept=0,color="red") + 
   labs(title="Residuals vs. logACET*indicator") + 
  theme(plot.title = element_text(hjust=0.5))

ggplot(data=honeySample,aes(x=logTHIAM*thiamInd,y=Residuals)) + geom_point() + 
  geom_hline(yintercept=0,color="red") + 
   labs(title="Residuals vs. logTHIAM*indicator") + 
  theme(plot.title = element_text(hjust=0.5))

ggplot(data=honeySample,aes(x=logTHIAC*thiacInd,y=Residuals)) + geom_point() + 
  geom_hline(yintercept=0,color="red") + 
   labs(title="Residuals vs. logTHIAC*indicator") + 
  theme(plot.title = element_text(hjust=0.5))

ggplot(data=honeySample, aes(sample=Residuals)) + stat_qq() + stat_qq_line() + 
  ggtitle("QQ Plot for Residuals")
```


```{r}
honeySample <- honeySample %>%
  mutate(leverage = hatvalues(interactionsModel), 
         cooks = cooks.distance(interactionsModel),
         stand.resid = rstandard(interactionsModel), 
         obs.num = row_number())

ggplot(data=honeySample, aes(x=obs.num,y=leverage)) + 
  geom_point(alpha=0.5) + 
  geom_hline(yintercept=0.1,color="red")+
  labs(x="Observation Number",y="Leverage",title="Leverage")
```

```{r}
ggplot(data=honeySample, aes(x=obs.num,y=cooks)) + 
  geom_point() + 
  geom_hline(yintercept=1,color="red")+
  labs(x="Observation Number",y="Cook's Distance",title="Cook's Distance")
```

```{r}
interactionsModel <- lm(logNC ~ Region + logIMID + logACET + logTHIAM + logTHIAC + Region*logIMID + Region*logACET + Region*logTHIAC + Region*logTHIAM +thiamInd + thiamInd*logTHIAM + thiacInd + thiacInd*logTHIAM, data=honeySample)
```

imid and acet had perfectly multicollinear stuff, removed

```{r}
library(car)
kable(tidy(vif(interactionsModel)))
```

```{r}
kable(glance(interactionsModel))
```

# Model 2

```{r}
# calBase <- lm(numcol ~ year + nTHIACLOPRID + nCLOTHIANIDIN, data=cal)
cal <- cal %>% mutate(Residuals = resid(calBase), Predicted = predict(calBase))


ggplot(data=cal,aes(x=year,y=Residuals)) + geom_point() + 
  geom_hline(yintercept=0,color="red") + 
   labs(title="Residuals vs. Year") + 
  theme(plot.title = element_text(hjust=0.5))

ggplot(data=cal,aes(x=Predicted,y=Residuals)) + geom_point() + 
  geom_hline(yintercept=0,color="red") + 
   labs(title="Residuals vs. Predicted") + 
  theme(plot.title = element_text(hjust=0.5))

ggplot(data=honeySample, aes(sample=Residuals)) + stat_qq() + stat_qq_line() + 
  ggtitle("QQ Plot for Residuals")
```

```{r}
cal <- cal %>%
  mutate(leverage = hatvalues(calBase), 
         cooks = cooks.distance(calBase),
         stand.resid = rstandard(calBase), 
         obs.num = row_number())

ggplot(data=cal, aes(x=obs.num,y=leverage)) + 
  geom_point(alpha=0.5) + 
  geom_hline(yintercept=0.1,color="red")+
  labs(x="Observation Number",y="Leverage",title="Leverage")
```

```{r}
ggplot(data=cal, aes(x=obs.num,y=cooks)) + 
  geom_point() + 
  geom_hline(yintercept=1,color="red")+
  labs(x="Observation Number",y="Cook's Distance",title="Cook's Distance")
```

```{r}
kable(glance(calBase))
```

```{r}
ggplot(data=honey, aes(x=year, y=nAllNeonic)) + geom_point() + ggtitle("All Pesticides vs Year")
```

```{r}
ggplot(data=honey, aes(x=year, y=numcol)) + geom_point() + ggtitle("Number of Colonies vs Year")
```

```{r}
tidy(calBase)
```

```{r}
dat = data.frame(year = c(2020, 2025, 2030, 2035, 2040, 2045))
predict.lm(calBase, newdata=dat, interval="prediction")
```

```{r}
dat = data.frame(logIMID = c(log(1000), log(5000), log(10000)), Region = c('Midwest', 'Midwest', 'Midwest'), logACET = c(0,0,0), logTHIAM = c(0,0,0), logTHIAC = c(0,0,0), thiamInd = c(0,0,0), thiacInd = c(0,0,0), acetInd = c(0,0,0), imidInd = c(1,1,1))
exp(predict.lm(interactionsModel, newdata = dat,interval="prediction"))
```

```{r}
```

?? Do we need to standardize year?

Yieldpercol ~ all pesticide types (not including nallNeonic) + year + state, and numcol ~ same values

1. oslr this

2. Do model without any of the pesticides, do a model with, anova

3. anova tests for all baseline models against models with one pesticide type included

4. interactions for all pesticide types between each other (anova this)

5. square and log transformations
