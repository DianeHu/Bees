---
title: "BeeProject"
author: "Diane Hu, Ashka Stephen, Jarod Cahoon"
date: "November 30, 2018"
output: html_document
---

```{r setup, message=F,include=F}
knitr::opts_chunk$set(echo = TRUE)
options(knitr.kable.NA = '')
```

```{r,include=FALSE}
library("tibble")
library("dplyr")
library("ggplot2")
library("broom")
library("knitr")
library("cowplot")
```

```{r}
honey <- read.csv("vHoneyNeonic_v02.csv")

honey <- na.omit(honey)
glimpse(honey)
```

```{r}
set.seed(7)

numObs <- summarize(honey, n = n())

honeySample <- sample_n(honey, as.integer(0.25*numObs))

honeySample <- honeySample %>% mutate(logCloth = log(nCLOTHIANIDIN), logIMID = log(nIMIDACLOPRID), logTHIAM = log(nTHIAMETHOXAM),
                                      logACET = log(nACETAMIPRID), logTHIAC = log(nTHIACLOPRID))

honeySample$logCloth[which(!is.finite(honeySample$logCloth))] = NA
honeySample$logIMID[which(!is.finite(honeySample$logIMID))] = NA
honeySample$logTHIAM[which(!is.finite(honeySample$logTHIAM))] = NA
honeySample$logACET[which(!is.finite(honeySample$logACET))] = NA
honeySample$logTHIAC[which(!is.finite(honeySample$logTHIAC))] = NA

honeySample <- na.omit(honeySample)

glimpse(honeySample)
```

```{r}
# Numcol against everything for exp data analysis

ncYear <- ggplot(honeySample, aes(x = year, y = numcol)) + geom_point() + geom_line() + ggtitle("Number of Colonies vs Year")
ncCloth <- ggplot(honeySample, aes(x = nCLOTHIANIDIN, y = numcol)) + geom_point() + ggtitle("Number of Colonies vs nCLOTHIANIDIN")
ncIMID <- ggplot(honeySample, aes(x = nIMIDACLOPRID, y = numcol)) + geom_point() + ggtitle("Number of Colonies vs nIMIDACLOPRID")
ncTHIAM <- ggplot(honeySample, aes(x = nTHIAMETHOXAM, y = numcol)) + geom_point() + ggtitle("Number of Colonies vs nTHIAMETHOXAM")
ncACET <- ggplot(honeySample, aes(x = nACETAMIPRID, y = numcol)) + geom_point() + ggtitle("Number of Colonies vs nACETAMIPRID")
ncTHIAC <- ggplot(honeySample, aes(x = nACETAMIPRID, y = numcol)) + geom_point() + ggtitle("Number of Colonies vs nTHIACLOPRID")
ncRegion <- ggplot(honeySample, aes(x = Region, y = numcol)) + geom_boxplot() + ggtitle("Number of colonies vs Region")
```

```{r}
ncYear
ncCloth
ncIMID
ncTHIAM
ncACET
ncTHIAC
ncRegion
```

```{r}
# Transformations

ncLCloth <- ggplot(honeySample, aes(x = logCloth, y = numcol)) + geom_point() + ggtitle("Number of Colonies vs Log nCLOTHIANIDIN")
ncLIMID <- ggplot(honeySample, aes(x = logIMID, y = numcol)) + geom_point() + ggtitle("Number of Colonies vs Log nIMIDACLOPRID")
ncLTHIAM <- ggplot(honeySample, aes(x = logTHIAM, y = numcol)) + geom_point() + ggtitle("Number of Colonies Log vs nTHIAMETHOXAM")
ncLACET <- ggplot(honeySample, aes(x = logACET, y = numcol)) + geom_point() + ggtitle("Number of Colonies vs Log nACETAMIPRID")
ncLTHIAC <- ggplot(honeySample, aes(x = logTHIAC, y = numcol)) + geom_point() + ggtitle("Number of Colonies vs Log nTHIACLOPRID")
```

```{r}
ncLCloth
ncLIMID
ncLTHIAM
ncLACET
ncLTHIAC
```

```{r}
cal <- honey %>% filter(StateName == "California")

cal = na.omit(cal)

glimpse(cal)
```

```{r}
cYear <- ggplot(cal, aes(x = year, y = numcol)) + geom_point() + geom_line() + ggtitle("Number of California Colonies vs Year")
cLCloth <- ggplot(cal, aes(x = nCLOTHIANIDIN, y = numcol)) + geom_point() + ggtitle("Number of California Colonies vs nCLOTHIANIDIN")
cLIMID <- ggplot(cal, aes(x = nIMIDACLOPRID, y = numcol)) + geom_point() + ggtitle("Number of California Colonies vs nIMIDACLOPRID")
cLTHIAM <- ggplot(cal, aes(x = nTHIAMETHOXAM, y = numcol)) + geom_point() + ggtitle("Number of California Colonies vs nTHIAMETHOXAM")
cLACET <- ggplot(cal, aes(x = nACETAMIPRID, y = numcol)) + geom_point() + ggtitle("Number of California Colonies vs nACETAMIPRID")
cLTHIAC <- ggplot(cal, aes(x = nTHIACLOPRID, y = numcol)) + geom_point() + ggtitle("Number of California Colonies vs nTHIACLOPRID")
```

```{r}
cYear
cLCloth
cLIMID
cLTHIAM
cLACET
cLTHIAC
```

# Model

```{r}
glimpse(honeySample)
```

```{r}
numcolFull <- lm(numcol ~ Region + logCloth + logIMID + logTHIAM + logACET + logTHIAC,data=honeySample)
kable(tidy(numcolFull))
```

```{r}
library(olsrr)
ols_step_forward_aic(numcolFull)
```

```{r}
baseModel <- lm(numcol ~ Region + logTHIAC + logTHIAM + logCloth, data=honeySample)
interactionsModel <- lm(numcol ~ Region + logTHIAC + logTHIAM + logCloth + Region*logCloth + Region*logTHIAM + Region*logTHIAC, data=honeySample)
kable(anova(baseModel, interactionsModel), format="html") # no significant interactions
```

```{r}
glimpse(cal)
```


```{r}
calFullModel <- lm(numcol ~ year + nCLOTHIANIDIN + nIMIDACLOPRID + nTHIAMETHOXAM + nACETAMIPRID + nTHIACLOPRID, data=cal)
kable(tidy(calFullModel))
```

```{r}
ols_step_forward_aic(calFullModel)
```

```{r}
pacf(cal$nTHIACLOPRID)
pacf(cal$nCLOTHIANIDIN)
```


```{r}
calBase <- lm(numcol ~ year + nTHIACLOPRID + nCLOTHIANIDIN, data=cal)
calInter <- lm(numcol ~ year + nTHIACLOPRID + nCLOTHIANIDIN + year*nTHIACLOPRID + year*nCLOTHIANIDIN, data=cal)
kable(anova(calBase, calInter), format="html") # interactions not significant
```

# Assumptions

# Model 1
```{r}
honeySample <- honeySample %>% mutate(Residuals = resid(baseModel), Predicted = predict(baseModel))

# Region + logTHIAC + logTHIAM + logCloth

ggplot(data=honeySample,aes(x=Region,y=Residuals)) + geom_point() + 
  geom_hline(yintercept=0,color="red") + 
   labs(title="Residuals vs. Region") + 
  theme(plot.title = element_text(hjust=0.5))

ggplot(data=honeySample,aes(x=logTHIAC,y=Residuals)) + geom_point() + 
  geom_hline(yintercept=0,color="red") + 
   labs(title="Residuals vs. logTHIAC") + 
  theme(plot.title = element_text(hjust=0.5))

ggplot(data=honeySample,aes(x=Predicted,y=Residuals)) + geom_point() + 
  geom_hline(yintercept=0,color="red") + 
   labs(title="Residuals vs. Predicted") + 
  theme(plot.title = element_text(hjust=0.5))

ggplot(data=honeySample,aes(x=logTHIAM,y=Residuals)) + geom_point() + 
  geom_hline(yintercept=0,color="red") + 
   labs(title="Residuals vs. logTHIAM") + 
  theme(plot.title = element_text(hjust=0.5))

ggplot(data=honeySample,aes(x=logCloth,y=Residuals)) + geom_point() + 
  geom_hline(yintercept=0,color="red") + 
   labs(title="Residuals vs. logCloth") + 
  theme(plot.title = element_text(hjust=0.5))

ggplot(data=honeySample, aes(sample=Residuals)) + stat_qq() + stat_qq_line() + 
  ggtitle("QQ Plot for Residuals")
```


```{r}
honeySample <- honeySample %>%
  mutate(leverage = hatvalues(baseModel), 
         cooks = cooks.distance(baseModel),
         stand.resid = rstandard(baseModel), 
         obs.num = row_number())

ggplot(data=honeySample, aes(x=obs.num,y=leverage)) + 
  geom_point(alpha=0.5) + 
  geom_hline(yintercept=0.1,color="red")+
  labs(x="Observation Number",y="Leverage",title="Leverage")
```

```{r}
ggplot(data=honeySample, aes(x=obs.num,y=cooks)) + 
  geom_point() + 
  geom_hline(yintercept=1,color="red")+
  labs(x="Observation Number",y="Cook's Distance",title="Cook's Distance")
```

```{r}
library(car)
kable(tidy(vif(baseModel)))
```

```{r}
kable(glance(baseModel))
```

# Model 2

```{r}
# calBase <- lm(numcol ~ year + nTHIACLOPRID + nCLOTHIANIDIN, data=cal)
cal <- cal %>% mutate(Residuals = resid(calBase), Predicted = predict(calBase))


ggplot(data=cal,aes(x=year,y=Residuals)) + geom_point() + 
  geom_hline(yintercept=0,color="red") + 
   labs(title="Residuals vs. Year") + 
  theme(plot.title = element_text(hjust=0.5))

ggplot(data=cal,aes(x=nTHIACLOPRID,y=Residuals)) + geom_point() + 
  geom_hline(yintercept=0,color="red") + 
   labs(title="Residuals vs. nTHIACLOPRID") + 
  theme(plot.title = element_text(hjust=0.5))

ggplot(data=cal,aes(x=nCLOTHIANIDIN,y=Residuals)) + geom_point() + 
  geom_hline(yintercept=0,color="red") + 
   labs(title="Residuals vs. nCLOTHIANIDIN") + 
  theme(plot.title = element_text(hjust=0.5))

ggplot(data=cal,aes(x=Predicted,y=Residuals)) + geom_point() + 
  geom_hline(yintercept=0,color="red") + 
   labs(title="Residuals vs. Predicted") + 
  theme(plot.title = element_text(hjust=0.5))

ggplot(data=honeySample, aes(sample=Residuals)) + stat_qq() + stat_qq_line() + 
  ggtitle("QQ Plot for Residuals")
```

```{r}
cal <- cal %>%
  mutate(leverage = hatvalues(calBase), 
         cooks = cooks.distance(calBase),
         stand.resid = rstandard(calBase), 
         obs.num = row_number())

ggplot(data=cal, aes(x=obs.num,y=leverage)) + 
  geom_point(alpha=0.5) + 
  geom_hline(yintercept=0.1,color="red")+
  labs(x="Observation Number",y="Leverage",title="Leverage")
```

```{r}
ggplot(data=cal, aes(x=obs.num,y=cooks)) + 
  geom_point() + 
  geom_hline(yintercept=1,color="red")+
  labs(x="Observation Number",y="Cook's Distance",title="Cook's Distance")
```

```{r}
kable(tidy(vif(calBase)))
```

```{r}
kable(glance(calBase))
```

```{r}
ggplot(data=honey, aes(x=year, y=nAllNeonic)) + geom_point()
```

?? Do we need to standardize year?

Yieldpercol ~ all pesticide types (not including nallNeonic) + year + state, and numcol ~ same values

1. oslr this

2. Do model without any of the pesticides, do a model with, anova

3. anova tests for all baseline models against models with one pesticide type included

4. interactions for all pesticide types between each other (anova this)

5. square and log transformations
